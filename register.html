<!DOCTYPE html>

<html>
	<head>
		<meta charset="utf-8">
		<title>IT-490-001 Registration Page</title>
	</head>

	<body>
		<section class="register-section">
			<h1>Register Below</h1>

			<form id="registerForm">
				<input type="text" name="username" id="username" placeholder="username" required>
				<br>
				<input type="password" name="password" id="password" placeholder="password" required>
				<br>
				<input type="email" for="email" name="email" placeholder="email" id="email" required>
				<br>
				<input type="hidden" name="type" value="register">
				<input type="submit" value="register">
			</form>
			<p id="textResponse">awaiting response</p>
		</section>
	<script>
			// You can add JavaScript here if needed for form validation or other purposes
		document.addEventListener("DOMContentLoaded", function() {
			const output = document.getElementById("textResponse");
			function HandleRegisterResponse(xhr){
				if (xhr.status !== 200){
					output.textContent = "Server Error: " + xhr.status + " " + xhr.statusText;
					return;
				}
				
				let res;

				try {
					res = JSON.parse(xhr.responseText);
				} catch {
					output.textContent = "Error parsing server response.";
					return;
				}

				const success =
					(res.status && res.status.toLowerCase() === "success") ||
					(res.returnCode === 0);

				if (success) {
					output.textContent = "Registration successful! Redirecting back to main page.";
					window.location.href = "index.html";
				} else {
					output.textContent = "Registration failed: " + (res.message || "Unknown error");
				}
			}
			
			function SendRegisterRequestJSON(registerData){
				var xhr = new XMLHttpRequest();
				xhr.open("POST","testRabbitMQClient.php"); // use absolute path
				xhr.setRequestHeader("Content-Type","application/json");
				xhr.onreadystatechange = function (){
					if (this.readyState === 4) HandleRegisterResponse(this);
				};
				xhr.send(JSON.stringify(registerData));
			}

		document.getElementById("registerForm").addEventListener("submit", (e) => {
			e.preventDefault(); // Prevent the default form submission
			const username = document.getElementById("username").value.trim();
			const password = document.getElementById("password").value;
			const email = document.getElementById("email").value.trim();
			SendRegisterRequestJSON({ 
				type: "register", 
				username,
				password,
				email
			});
		});
	});
	</script>
	</body>
</html>
